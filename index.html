<!DOCTYPE html>
<html>

<head>
    <title>Health Data Visualization</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .button-container button {
            margin: 0 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Health Data Form</h1>
        <form id="healthForm">
            <div class="form-group">
                <label for="date">Date:</label>
                <input type="text" class="form-control" id="date" name="date" readonly>
            </div>
            <div class="form-group">
                <label for="systolic">Systolic:</label>
                <input type="number" class="form-control" id="systolic" name="systolic" required>
            </div>
            <div class="form-group">
                <label for="diastolic">Diastolic:</label>
                <input type="number" class="form-control" id="diastolic" name="diastolic" required>
            </div>
            <div class="form-group">
                <label for="weight">Weight:</label>
                <input type="number" class="form-control" id="weight" name="weight" required>
            </div>
            <input type="submit" class="btn btn-primary" value="Add/Update">
        </form>

        <div class="chart-container">
            <canvas id="healthChart"></canvas>
        </div>

        <div class="button-container">
            <button class="btn btn-outline-secondary" onclick="setRange(30)">30</button>
            <button class="btn btn-outline-secondary" onclick="setRange(60)">60</button>
            <button class="btn btn-outline-secondary" onclick="setRange(90)">90</button>
            <button class="btn btn-outline-secondary" onclick="setRange(365)">365</button>
        </div>

        <h2>Stored Data</h2>
        <table id="dataTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Systolic</th>
                    <th>Diastolic</th>
                    <th>Weight</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const healthChart = new Chart(
            document.getElementById('healthChart'),
            {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Systolic',
                            data: [],
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.2)',
                            fill: false,
                            lineTension: 0.1
                        },
                        {
                            label: 'Diastolic',
                            data: [],
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.2)',
                            fill: false,
                            lineTension: 0.1
                        },
                        {
                            label: 'Weight',
                            data: [],
                            borderColor: 'green',
                            backgroundColor: 'rgba(0, 128, 0, 0.2)',
                            fill: false,
                            lineTension: 0.1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'black' // Set the color of the horizontal grid lines to black
                            }
                        }
                    },

                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Health Data'
                        }
                    }
                }
            }
        );

        function setRange(days) {
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);
            const storedData = JSON.parse(localStorage.getItem('healthData') || '[]');
            const filteredData = storedData.filter(item => new Date(item.date) >= startDate);

            const labels = filteredData.map(item => item.date);
            const systolicData = [];
            const diastolicData = [];
            const weightData = [];

            let prevSystolic, prevDiastolic, prevWeight;

            for (const item of filteredData) {
                const { date, systolic, diastolic, weight } = item;

                if (systolic !== null) {
                    systolicData.push(systolic);
                    prevSystolic = systolic;
                } else {
                    systolicData.push(prevSystolic || null);
                }

                if (diastolic !== null) {
                    diastolicData.push(diastolic);
                    prevDiastolic = diastolic;
                } else {
                    diastolicData.push(prevDiastolic || null);
                }

                if (weight !== null) {
                    weightData.push(weight);
                    prevWeight = weight;
                } else {
                    weightData.push(prevWeight || null);
                }
            }

            healthChart.data.labels = labels;
            healthChart.data.datasets[0].data = systolicData;
            healthChart.data.datasets[1].data = diastolicData;
            healthChart.data.datasets[2].data = weightData;
            healthChart.update();

            populateTable(filteredData);
        }

        function populateTable(data) {
            const tableBody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            // Sort data by date descending
            data.sort((a, b) => new Date(b.date) - new Date(a.date));

            data.forEach(item => {
                const row = document.createElement('tr');
                const dateCell = document.createElement('td');
                const systolicCell = document.createElement('td');
                const diastolicCell = document.createElement('td');
                const weightCell = document.createElement('td');
                const deleteCell = document.createElement('td');
                const deleteButton = document.createElement('button');

                dateCell.innerHTML = `<a href="#" onclick="loadData('${item.date}')">${item.date}</a>`;
                systolicCell.textContent = item.systolic || '';
                diastolicCell.textContent = item.diastolic || '';
                weightCell.textContent = item.weight || '';
                deleteButton.textContent = 'X';
                deleteButton.onclick = () => deleteRecord(item.date);

                deleteCell.appendChild(deleteButton);

                row.appendChild(dateCell);
                row.appendChild(systolicCell);
                row.appendChild(diastolicCell);
                row.appendChild(weightCell);
                row.appendChild(deleteCell);

                tableBody.appendChild(row);
            });
        }

        // Load stored data from local storage and populate the table and chart
        const storedData = JSON.parse(localStorage.getItem('healthData') || '[]');
        setRange(90); // Set the initial range to 90 days

        // Add an event listener for form submission
        const form = document.getElementById('healthForm');
        form.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the form from submitting normally

            // Get the form data
            const systolic = document.getElementById('systolic').value;
            const diastolic = document.getElementById('diastolic').value;
            const weight = document.getElementById('weight').value;
            const date = document.getElementById('date').value;

            // Check if there is already data for the current date
            const existingDataIndex = storedData.findIndex(item => item.date === date);

            if (existingDataIndex >= 0) {
                // Update existing record
                storedData[existingDataIndex] = {
                    date,
                    systolic,
                    diastolic,
                    weight
                };
            } else {
                // Add new record
                storedData.push({
                    date,
                    systolic,
                    diastolic,
                    weight
                });
            }

            // Store the data in the browser's local storage
            localStorage.setItem('healthData', JSON.stringify(storedData));

            // Update the table and chart
            setRange(90);
        });

        // Function to format the date as yyyy-mm-dd
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        // Function to check for existing data on page load and populate form if data exists
        function loadExistingData() {
            const currentDate = formatDate(new Date());
            const existingData = storedData.find(item => item.date === currentDate);

            document.getElementById('date').value = currentDate;

            if (existingData) {
                document.getElementById('systolic').value = existingData.systolic;
                document.getElementById('diastolic').value = existingData.diastolic;
                document.getElementById('weight').value = existingData.weight;
                form.querySelector('input[type="submit"]').value = 'Add/Update';
            }
        }

        // Function to load data into the form for updating
        function loadData(date) {
            const existingData = storedData.find(item => item.date === date);

            if (existingData) {
                document.getElementById('date').value = existingData.date;
                document.getElementById('systolic').value = existingData.systolic;
                document.getElementById('diastolic').value = existingData.diastolic;
                document.getElementById('weight').value = existingData.weight;
                form.querySelector('input[type="submit"]').value = 'Add/Update';
            }
        }

        // Function to delete a record
        function deleteRecord(date) {
            const index = storedData.findIndex(item => item.date === date);
            if (index !== -1) {
                storedData.splice(index, 1);
                localStorage.setItem('healthData', JSON.stringify(storedData));
                setRange(90);
            }
        }

        // Load existing data on page load
        loadExistingData();
    </script>
</body>

</html>